<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора | Чёрный Архив</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #0a0a0f;
            --accent-red: #c41e3a;
            --accent-yellow: #d4af37;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0b0;
            --border-color: #252530;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--primary-dark);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Авторизация */
        .login-screen {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }

        .login-form {
            background: rgba(20, 20, 30, 0.9);
            padding: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Панель управления */
        .admin-panel {
            display: none;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent-red);
        }

        .admin-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
        }

        .nav-btn.active {
            background: var(--accent-red);
            border-color: var(--accent-red);
        }

        /* Контент */
        .content-section {
            display: none;
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .content-section.active {
            display: block;
        }

        /* Статистика */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(30, 30, 40, 0.6);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
        }

        .stat-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            color: var(--accent-yellow);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: rgba(30, 30, 40, 0.6);
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-yellow);
        }

        .btn-small {
            padding: 5px 10px;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 5px;
        }

        .btn-small.secondary {
            background: transparent;
            border: 1px solid var(--border-color);
        }

        /* Экспорт */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        /* Нотификации */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            background: #2e7d32;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            display: none;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Экран авторизации -->
    <div class="login-screen" id="loginScreen">
        <div class="login-form">
            <h2 style="color: var(--accent-red); margin-bottom: 20px;">
                <i class="fas fa-user-secret"></i> АРХИВ АДМИНИСТРАТОРА
            </h2>
            <input type="password" id="adminPassword" placeholder="Введите пароль доступа" autocomplete="off">
            <button onclick="checkPassword()">Войти в систему</button>
            <p style="margin-top: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Пароль по умолчанию: архив2024
            </p>
        </div>
    </div>

    <!-- Панель администратора -->
    <div class="admin-container" id="adminPanel" style="display: none;">
        <div class="admin-header">
            <h1 style="font-family: 'JetBrains Mono', monospace;">
                <i class="fas fa-terminal"></i> Панель управления | Чёрный Архив
            </h1>
            <button class="btn-small secondary" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Выйти
            </button>
        </div>

        <!-- Навигация -->
        <div class="admin-nav">
            <button class="nav-btn active" data-tab="analytics">
                <i class="fas fa-chart-bar"></i> Аналитика
            </button>
            <button class="nav-btn" data-tab="userArticles">
                <i class="fas fa-file-alt"></i> Статьи пользователей
            </button>
            <button class="nav-btn" data-tab="visits">
                <i class="fas fa-users"></i> Посещения
            </button>
            <button class="nav-btn" data-tab="export">
                <i class="fas fa-download"></i> Экспорт данных
            </button>
        </div>

        <!-- Секция аналитики -->
        <div id="analytics" class="content-section active">
            <h2 style="color: var(--accent-red); margin-bottom: 20px;">
                <i class="fas fa-chart-line"></i> Сводная статистика
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Всего посещений</div>
                    <div class="stat-number" id="totalVisits">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Уникальные посетители</div>
                    <div class="stat-number" id="uniqueVisitors">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Статей от пользователей</div>
                    <div class="stat-number" id="userArticlesCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Среднее время на сайте</div>
                    <div class="stat-number" id="avgTime">0с</div>
                </div>
            </div>

            <h3 style="margin: 30px 0 15px; color: var(--accent-yellow);">
                <i class="fas fa-calendar-alt"></i> Посещения по дням
            </h3>
            <div id="dailyStats"></div>

            <h3 style="margin: 30px 0 15px; color: var(--accent-yellow);">
                <i class="fas fa-file"></i> Популярные страницы
            </h3>
            <div id="popularPages"></div>
        </div>

        <!-- Статьи пользователей -->
        <div id="userArticles" class="content-section">
            <h2 style="color: var(--accent-red); margin-bottom: 20px;">
                <i class="fas fa-inbox"></i> Предложенные статьи
            </h2>
            
            <div class="export-buttons">
                <button class="btn-small" onclick="exportUserArticles()">
                    <i class="fas fa-download"></i> Экспорт в JSON
                </button>
                <button class="btn-small secondary" onclick="clearUserArticles()">
                    <i class="fas fa-trash"></i> Очистить все
                </button>
            </div>
            
            <div id="articlesList"></div>
        </div>

        <!-- Детали посещений -->
        <div id="visits" class="content-section">
            <h2 style="color: var(--accent-red); margin-bottom: 20px;">
                <i class="fas fa-history"></i> История посещений
            </h2>
            
            <div class="export-buttons">
                <button class="btn-small" onclick="exportVisits()">
                    <i class="fas fa-download"></i> Экспорт посещений
                </button>
                <button class="btn-small secondary" onclick="clearOldVisits()">
                    <i class="fas fa-trash"></i> Очистить старые
                </button>
            </div>
            
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Время</th>
                            <th>Страница</th>
                            <th>Источник</th>
                            <th>Устройство</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Экспорт данных -->
        <div id="export" class="content-section">
            <h2 style="color: var(--accent-red); margin-bottom: 20px;">
                <i class="fas fa-database"></i> Управление данными
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 style="color: var(--accent-yellow); margin-bottom: 15px;">
                        <i class="fas fa-file-export"></i> Экспорт
                    </h3>
                    <p style="margin-bottom: 15px; color: var(--text-secondary);">
                        Скачайте все данные в JSON формате для резервного копирования или анализа
                    </p>
                    <button class="btn-small" onclick="exportAllData()" style="width: 100%;">
                        <i class="fas fa-download"></i> Экспортировать ВСЁ
                    </button>
                </div>
                
                <div class="stat-card">
                    <h3 style="color: var(--accent-yellow); margin-bottom: 15px;">
                        <i class="fas fa-file-import"></i> Импорт
                    </h3>
                    <p style="margin-bottom: 15px; color: var(--text-secondary);">
                        Восстановите данные из резервной копии
                    </p>
                    <input type="file" id="importFile" accept=".json" style="width: 100%; margin-bottom: 10px;">
                    <button class="btn-small secondary" onclick="importData()" style="width: 100%;">
                        <i class="fas fa-upload"></i> Импортировать
                    </button>
                </div>
                
                <div class="stat-card">
                    <h3 style="color: var(--accent-yellow); margin-bottom: 15px;">
                        <i class="fas fa-cog"></i> Настройки
                    </h3>
                    <p style="margin-bottom: 15px; color: var(--text-secondary);">
                        Пароль администратора
                    </p>
                    <input type="password" id="newPassword" placeholder="Новый пароль" style="width: 100%; margin-bottom: 10px;">
                    <button class="btn-small" onclick="changePassword()" style="width: 100%;">
                        <i class="fas fa-key"></i> Изменить пароль
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div class="notification" id="notification"></div>

    <script>
        // Пароль по умолчанию (измените его!)
        const DEFAULT_PASSWORD = 'архив2024';
        let isAuthenticated = false;

        // Проверка пароля
        function checkPassword() {
            const password = document.getElementById('adminPassword').value;
            const savedPassword = localStorage.getItem('black_archive_admin_password') || DEFAULT_PASSWORD;
            
            if (password === savedPassword) {
                isAuthenticated = true;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
                showNotification('Доступ разрешён', 'success');
            } else {
                showNotification('Неверный пароль', 'error');
                document.getElementById('adminPassword').value = '';
            }
        }

        // Выход
        function logout() {
            isAuthenticated = false;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        // Загрузка данных в панель
        function loadAdminData() {
            if (!isAuthenticated) return;
            
            // Загрузка статистики
            loadStatistics();
            
            // Загрузка статей пользователей
            loadUserArticles();
            
            // Загрузка посещений
            loadVisits();
            
            // Настройка навигации
            setupNavigation();
        }

        // Загрузка статистики
        function loadStatistics() {
            try {
                // Все посещения
                const visits = JSON.parse(localStorage.getItem('black_archive_visits') || '[]');
                document.getElementById('totalVisits').textContent = visits.length;
                
                // Уникальные посетители
                const visitorIds = new Set(visits.map(v => v.id));
                document.getElementById('uniqueVisitors').textContent = visitorIds.size;
                
                // Статьи пользователей
                const articles = JSON.parse(localStorage.getItem('black_archive_ideas') || '[]');
                document.getElementById('userArticlesCount').textContent = articles.length;
                
                // Среднее время
                const timeStats = JSON.parse(localStorage.getItem('black_archive_time_stats') || '[]');
                const avgTime = timeStats.length > 0 
                    ? Math.round(timeStats.reduce((sum, stat) => sum + stat.timeSpent, 0) / timeStats.length)
                    : 0;
                document.getElementById('avgTime').textContent = avgTime + 'с';
                
                // Статистика по дням
                const dailyStats = JSON.parse(localStorage.getItem('black_archive_daily_stats') || '{}');
                displayDailyStats(dailyStats);
                
                // Популярные страницы
                displayPopularPages(visits);
                
            } catch (e) {
                console.error('Ошибка загрузки статистики:', e);
            }
        }

        // Отображение статистики по дням
        function displayDailyStats(dailyStats) {
            const container = document.getElementById('dailyStats');
            const days = Object.keys(dailyStats).sort().reverse().slice(0, 10); // Последние 10 дней
            
            let html = '<table><thead><tr><th>Дата</th><th>Уникальные</th><th>Просмотры</th></tr></thead><tbody>';
            
            days.forEach(date => {
                const stats = dailyStats[date];
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${(stats.uniqueVisitors || []).length}</td>
                        <td>${stats.pageViews || 0}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Популярные страницы
        function displayPopularPages(visits) {
            const pageCounts = {};
            visits.forEach(visit => {
                const page = visit.page || '/';
                pageCounts[page] = (pageCounts[page] || 0) + 1;
            });
            
            const popular = Object.entries(pageCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const container = document.getElementById('popularPages');
            let html = '<table><thead><tr><th>Страница</th><th>Посещения</th></tr></thead><tbody>';
            
            popular.forEach(([page, count]) => {
                html += `
                    <tr>
                        <td>${page}</td>
                        <td>${count}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Загрузка статей пользователей
        function loadUserArticles() {
            try {
                const articles = JSON.parse(localStorage.getItem('black_archive_ideas') || '[]');
                const container = document.getElementById('articlesList');
                
                if (articles.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Нет предложенных статей</p>';
                    return;
                }
                
                let html = '<table><thead><tr><th>Дата</th><th>Ютубер</th><th>Идея</th><th>Автор</th><th>Действия</th></tr></thead><tbody>';
                
                articles.reverse().forEach((article, index) => {
                    html += `
                        <tr>
                            <td>${article.date || 'Неизвестно'}</td>
                            <td><strong>${escapeHtml(article.youtuber || '')}</strong></td>
                            <td>${escapeHtml(article.idea?.substring(0, 100) || '')}${article.idea?.length > 100 ? '...' : ''}</td>
                            <td>${escapeHtml(article.name || 'Аноним')}</td>
                            <td>
                                <button class="btn-small" onclick="viewArticle(${articles.length - 1 - index})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-small secondary" onclick="deleteArticle(${articles.length - 1 - index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('Ошибка загрузки статей:', e);
            }
        }

        // Просмотр статьи
        function viewArticle(index) {
            try {
                const articles = JSON.parse(localStorage.getItem('black_archive_ideas') || '[]');
                const article = articles[index];
                
                if (article) {
                    alert(`Детали статьи:\n\nЮтубер: ${article.youtuber}\nАвтор: ${article.name}\nКонтакт: ${article.contact || 'Нет'}\n\nИдея:\n${article.idea}`);
                }
            } catch (e) {
                console.error('Ошибка просмотра статьи:', e);
            }
        }

        // Удаление статьи
        function deleteArticle(index) {
            if (confirm('Удалить эту статью?')) {
                try {
                    const articles = JSON.parse(localStorage.getItem('black_archive_ideas') || '[]');
                    articles.splice(index, 1);
                    localStorage.setItem('black_archive_ideas', JSON.stringify(articles));
                    loadUserArticles();
                    showNotification('Статья удалена', 'success');
                } catch (e) {
                    console.error('Ошибка удаления статьи:', e);
                }
            }
        }

        // Загрузка посещений
        function loadVisits() {
            try {
                const visits = JSON.parse(localStorage.getItem('black_archive_visits') || '[]');
                const container = document.getElementById('visitsTable');
                
                if (visits.length === 0) {
                    container.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">Нет данных о посещениях</td></tr>';
                    return;
                }
                
                let html = '';
                visits.reverse().slice(0, 50).forEach(visit => {
                    html += `
                        <tr>
                            <td>${visit.date || ''}</td>
                            <td>${visit.time || ''}</td>
                            <td>${visit.page || '/'}</td>
                            <td>${getReferrerName(visit.referrer)}</td>
                            <td>${visit.screen || ''}</td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error('Ошибка загрузки посещений:', e);
            }
        }

        // Определение источника
        function getReferrerName(referrer) {
            if (!referrer || referrer === 'direct') return 'Прямой заход';
            if (referrer.includes('vk.com')) return 'ВКонтакте';
            if (referrer.includes('t.me')) return 'Telegram';
            if (referrer.includes('youtube.com')) return 'YouTube';
            return 'Сайт';
        }

        // Навигация
        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    
                    // Обновляем активные кнопки
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Показываем нужную секцию
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(tab).classList.add('active');
                });
            });
        }

        // Экспорт статей пользователей
        function exportUserArticles() {
            try {
                const articles = JSON.parse(localStorage.getItem('black_archive_ideas') || '[]');
                const dataStr = JSON.stringify(articles, null, 2);
                downloadFile(dataStr, 'user_articles.json', 'application/json');
                showNotification('Статьи экспортированы', 'success');
            } catch (e) {
                console.error('Ошибка экспорта:', e);
            }
        }

        // Экспорт посещений
        function exportVisits() {
            try {
                const visits = JSON.parse(localStorage.getItem('black_archive_visits') || '[]');
                const dataStr = JSON.stringify(visits, null, 2);
                downloadFile(dataStr, 'visits.json', 'application/json');
                showNotification('Посещения экспортированы', 'success');
            } catch (e) {
                console.error('Ошибка экспорта:', e);
            }
        }

        // Экспорт всех данных
        function exportAllData() {
            try {
                const allData = {
                    articles: JSON.parse(localStorage.getItem('black_archive_ideas') || '[]'),
                    visits: JSON.parse(localStorage.getItem('black_archive_visits') || '[]'),
                    dailyStats: JSON.parse(localStorage.getItem('black_archive_daily_stats') || '{}'),
                    timeStats: JSON.parse(localStorage.getItem('black_archive_time_stats') || '[]'),
                    exportedAt: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(allData, null, 2);
                downloadFile(dataStr, 'black_archive_backup.json', 'application/json');
                showNotification('Все данные экспортированы', 'success');
            } catch (e) {
                console.error('Ошибка экспорта:', e);
            }
        }

        // Импорт данных
        function importData() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                showNotification('Выберите файл', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.articles) localStorage.setItem('black_archive_ideas', JSON.stringify(data.articles));
                    if (data.visits) localStorage.setItem('black_archive_visits', JSON.stringify(data.visits));
                    if (data.dailyStats) localStorage.setItem('black_archive_daily_stats', JSON.stringify(data.dailyStats));
                    if (data.timeStats) localStorage.setItem('black_archive_time_stats', JSON.stringify(data.timeStats));
                    
                    showNotification('Данные импортированы', 'success');
                    loadAdminData();
                    fileInput.value = '';
                    
                } catch (e) {
                    showNotification('Ошибка формата файла', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Очистка статей
        function clearUserArticles() {
            if (confirm('Удалить ВСЕ предложенные статьи?')) {
                localStorage.removeItem('black_archive_ideas');
                loadUserArticles();
                showNotification('Все статьи удалены', 'success');
            }
        }

        // Очистка старых посещений
        function clearOldVisits() {
            if (confirm('Оставить только посещения за последние 30 дней?')) {
                try {
                    const visits = JSON.parse(localStorage.getItem('black_archive_visits') || '[]');
                    const monthAgo = new Date();
                    monthAgo.setDate(monthAgo.getDate() - 30);
                    
                    const filteredVisits = visits.filter(visit => {
                        const visitDate = new Date(visit.timestamp);
                        return visitDate > monthAgo;
                    });
                    
                    localStorage.setItem('black_archive_visits', JSON.stringify(filteredVisits));
                    loadVisits();
                    showNotification('Старые данные удалены', 'success');
                } catch (e) {
                    console.error('Ошибка очистки:', e);
                }
            }
        }

        // Смена пароля
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (newPassword && newPassword.length >= 4) {
                localStorage.setItem('black_archive_admin_password', newPassword);
                document.getElementById('newPassword').value = '';
                showNotification('Пароль изменён', 'success');
            } else {
                showNotification('Пароль слишком короткий', 'error');
            }
        }

        // Утилиты
        function downloadFile(content, fileName, contentType) {
            const a = document.createElement('a');
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'error' ? 'var(--accent-red)' : '#2e7d32';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Автоматическая проверка авторизации при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            const savedPassword = localStorage.getItem('black_archive_admin_password') || DEFAULT_PASSWORD;
            // Можно добавить автоматический вход по cookies, но для безопасности лучше оставить ручной
        });
    </script>
</body>
</html>
